<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Xero Search</title>

  <style>
    :root {
      --primary-color: #13b5ea;
      /* Xero blue */
      --primary-dark: #0e95c4;
      --secondary-color: #273238;
      --background-color: #f9f9f9;
      --card-background: #ffffff;
      --text-color: #333333;
      --border-color: #e2e2e2;
      --success-color: #36af47;
      /* Xero green */
      --error-color: #d0021b;
      --info-color: #2d9cdb;
      --warning-color: #f2c94c;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    header {
      background-color: var(--secondary-color);
      color: white;
      padding: 1rem 0;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 {
      font-size: 1.5rem;
      font-weight: 600;
    }

    main {
      padding: 2rem 0;
      min-height: calc(100vh - 130px);
    }

    footer {
      background-color: var(--secondary-color);
      color: rgba(255, 255, 255, 0.7);
      padding: 1rem 0;
      font-size: 0.875rem;
      text-align: center;
    }

    /* Buttons */
    .btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 600;
      text-align: center;
      transition: all 0.2s ease;
    }

    .btn.primary {
      background-color: var(--primary-color);
      color: white;
    }

    .btn.primary:hover {
      background-color: var(--primary-dark);
    }

    .btn.secondary {
      background-color: #f1f1f1;
      color: var(--secondary-color);
    }

    .btn.secondary:hover {
      background-color: #e0e0e0;
    }

    /* Messages */
    .message {
      padding: 1rem;
      border-radius: 4px;
      margin-bottom: 1.5rem;
    }

    .message.info {
      background-color: rgba(45, 156, 219, 0.1);
      border: 1px solid var(--info-color);
      color: var(--info-color);
    }

    .message.error {
      background-color: rgba(208, 2, 27, 0.1);
      border: 1px solid var(--error-color);
      color: var(--error-color);
    }

    .message.success {
      background-color: rgba(54, 175, 71, 0.1);
      border: 1px solid var(--success-color);
      color: var(--success-color);
    }

    /* Search Section */
    #search-section {
      background-color: var(--card-background);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
    }

    #search-section h2 {
      margin-bottom: 1rem;
      font-size: 1.25rem;
      color: var(--secondary-color);
    }

    .search-container {
      display: flex;
      margin-bottom: 1rem;
      gap: 0.5rem;
    }

    .search-container input {
      flex: 1;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
    }

    .search-container input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(19, 181, 234, 0.1);
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      padding: 1rem;
      background-color: rgba(0, 0, 0, 0.02);
      border-radius: 4px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .filter-group label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--secondary-color);
    }

    .filter-group select,
    .filter-group input {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      min-width: 150px;
    }

    /* Results Section */
    #results-section {
      background-color: var(--card-background);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      flex-wrap: wrap;
      gap: 1rem;
    }

    .results-header h2 {
      font-size: 1.25rem;
      color: var(--secondary-color);
    }

    .sorting {
      display: flex;
      gap: 0.5rem;
    }

    .sorting select {
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 0.875rem;
    }

    .result-item {
      padding: 1.25rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .result-item:hover {
      border-color: var(--primary-color);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }

    .invoice-number { /* Target specifically for icons */
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--secondary-color);
      display: flex; /* Use flex to align text and icons */
      align-items: center; /* Vertically align */
    }

    .invoice-status-icons { /* Container for icons */
       margin-left: 10px; /* Space between invoice number and icons */
       display: inline-flex; /* Keep icons inline */
       gap: 5px; /* Space between icons if both appear */
       font-size: 0.9em; /* Adjust icon size slightly */
    }

    .status-icon { /* Common styling for icons */
        cursor: default; /* Indicate they aren't clickable */
    }

    .invoice-status { /* The text status badge */
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-draft { background-color: #f3f4f6; color: #6b7280; }
    .status-submitted { background-color: #fef3c7; color: #d97706; }
    .status-authorised { background-color: #dbeafe; color: #2563eb; }
    .status-paid { background-color: #d1fae5; color: #059669; }

    .result-details { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem; font-size: 0.875rem; }
    .result-details div { display: flex; flex-direction: column; }
    .result-details span:first-child { color: #6b7280; font-size: 0.75rem; }

    /* Invoice Detail Section */
    #detail-section { background-color: var(--card-background); border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
    #back-btn { background-color: var(--primary-color); color: white; border-color: var(--primary-color); margin-bottom: 1.5rem; }
    #back-btn:hover { background-color: var(--primary-dark); border-color: var(--primary-dark); }
    .invoice-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
    .invoice-header h2 { font-size: 1.5rem; color: var(--secondary-color); }
    .invoice-meta { display: grid; grid-template-columns: repeat(2, 1fr); gap: 2.5rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); }
    .invoice-meta-group h3 { margin-bottom: 0.8rem; color: var(--secondary-color); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .invoice-meta-group div { line-height: 1.5; margin-bottom: 0.4rem; font-size: 0.9rem; }
    .invoice-meta-group strong { color: #555; min-width: 85px; display: inline-block; margin-right: 0.5rem; font-weight: 500; }
    .invoice-meta-group .address-block { margin-top: 0.2rem; }
    .invoice-meta-group .address-block span { display: block; margin-left: 90px; margin-top: -1.6em; line-height: 1.4; }
    .invoice-meta-group .address-block span:first-child { margin-top: -1.6em; }
    .invoice-meta-group .address-block span+span { margin-top: 0; }
    .invoice-meta-group strong+br { display: none; }
    .invoice-items { display: block; width: 100%; box-sizing: border-box; margin-top: 2rem; }
    .invoice-items>h3 { font-size: 1.25rem; color: var(--secondary-color); margin-bottom: 1.5rem; }
    .invoice-items table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; table-layout: fixed; }
    .invoice-items th { text-align: left; padding: 0.75rem; background-color: rgba(0, 0, 0, 0.02); font-weight: 600; color: var(--secondary-color); border-bottom: 1px solid var(--border-color); }
    .invoice-items td { padding: 0.75rem; border-bottom: 1px solid var(--border-color); font-size: 0.875rem; }
    .invoice-items .text-right { text-align: right; }
    .invoice-items tfoot td { font-weight: 600; }
    .invoice-items .total-row { font-size: 1rem; background-color: rgba(0, 0, 0, 0.02); }
    @media (max-width: 768px) { .invoice-meta { grid-template-columns: 1fr; gap: 1.8rem; } .invoice-meta-group .address-block span { margin-left: 0; margin-top: 0.2rem; } .invoice-meta-group .address-block span:first-child { margin-top: 0.2rem; } .invoice-items { overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; } .invoice-items table { min-width: 600px; width: 100%; } }

    /* Pagination */
    #pagination { display: flex; justify-content: center; gap: 1rem; margin-top: 1.5rem; }
    #pagination button { padding: 0.625rem 1.25rem; border: 1px solid var(--border-color); background-color: white; cursor: pointer; border-radius: 4px; font-size: 0.875rem; min-width: 120px; font-weight: 500; transition: all 0.2s ease; }
    #pagination button:hover { border-color: var(--primary-color); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
    #pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    #pagination button:first-child { border-color: var(--border-color); } /* Note: This styles the first button (might be 'First' or 'Previous') */
    #pagination button:last-child { background-color: var(--primary-color); color: white; border-color: var(--primary-color); } /* Styles the last button (might be 'Next' or 'Previous') */
    #pagination button:last-child:hover { background-color: var(--primary-dark); }

    /* Loading spinner */
    #loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; }
    .spinner { width: 40px; height: 40px; border: 4px solid rgba(19, 181, 234, 0.2); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 0.8s linear infinite; margin-bottom: 1rem; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Utility */
    .hidden { display: none !important; }

    /* Responsive */
    @media (max-width: 768px) { header .container { flex-direction: column; text-align: center; gap: 1rem; } .search-container { flex-direction: column; } .results-header { flex-direction: column; align-items: flex-start; } .sorting { width: 100%; } .sorting select { flex: 1; } }

    /* Tenant selection */
    .tenant-select { margin-left: 10px; padding: 3px 6px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 4px; background-color: rgba(255, 255, 255, 0.1); color: white; font-size: 0.85rem; }
    .tenant-select:focus { outline: none; border-color: var(--primary-color); }
    #user-section { display: flex; align-items: center; flex-wrap: wrap; gap: 10px; }
    #user-info { display: flex; flex-direction: column; min-width: 200px; margin-right: 15px; }

    /* Job status */
    .job-age { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-top: 0.5rem; }
    .job-recent { background-color: #e6f7ff; color: #0070d1; }
    .job-approaching { background-color: #fff7e6; color: #d46b08; }
    .job-overdue { background-color: #fff1f0; color: #cf1322; font-weight: bold; }
    .result-item.overdue { border-left: 3px solid #cf1322; }
    .result-item.approaching { border-left: 3px solid #d46b08; }

    /* Transitions */
    #results-section { transition: opacity 0.3s ease; }
    #results-list { transition: opacity 0.2s ease; }
    .loading-indicator { display: flex; justify-content: center; padding: 20px; }

    /* Autocomplete */
    .search-container { position: relative; }
    .autocomplete-items { position: absolute; border: 1px solid var(--border-color); border-top: none; background-color: var(--card-background); z-index: 99; top: 100%; left: 0; right: 0; max-height: 250px; overflow-y: auto; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); border-bottom-left-radius: 4px; border-bottom-right-radius: 4px; }
    .autocomplete-items div { padding: 0.75rem; cursor: pointer; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; }
    .autocomplete-items div:last-child { border-bottom: none; }
    .autocomplete-items div:hover { background-color: #e9e9e9; }
    .autocomplete-items div strong { font-weight: 600; color: var(--primary-dark); }

    /* Input Clear Button */
    .input-wrapper { position: relative; flex: 1; }
    #search-input { padding-right: 35px; width: 100%; }
    .clear-search-icon { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 1.4rem; line-height: 1; color: #999; z-index: 2; }
    .clear-search-icon:hover { color: #333; }

    /* Tabs */
    .tabs-container { margin-top: 2rem; }
    .tabs-nav { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .tab-button { padding: 0.75rem 1.25rem; background: none; border: none; border-bottom: 3px solid transparent; font-size: 1rem; font-weight: 500; color: #555; cursor: pointer; transition: all 0.2s ease; }
    .tab-button:hover { color: var(--primary-color); }
    .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Notes & Reminders Common */
    .item-list { margin-bottom: 2rem; }
    .item-card { background-color: white; border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; position: relative; }
    .item-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .item-date { font-size: 0.75rem; color: #666; }
    .item-actions { position: absolute; top: 0.75rem; right: 0.75rem; display: flex; gap: 0.5rem; }
    .item-action-btn { background: none; border: none; cursor: pointer; color: #888; padding: 0.25rem; font-size: 1rem; transition: color 0.2s ease; }
    .item-action-btn:hover { color: var(--primary-color); }
    .item-action-btn.delete:hover { color: var(--error-color); }
    .item-content { line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .add-item-form { background-color: #f9f9f9; border: 1px solid var(--border-color); border-radius: 6px; padding: 1.25rem; }
    .form-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; }
    .form-row { margin-bottom: 1rem; }
    .form-row label { display: block; font-size: 0.875rem; margin-bottom: 0.25rem; font-weight: 500; }
    .form-row input[type="text"], .form-row textarea, .form-row select, .form-row input[type="date"] { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95rem; }
    .form-row textarea { min-height: 100px; resize: vertical; }
    .form-actions { display: flex; justify-content: flex-end; gap: 0.75rem; }

    /* Note categories */
    .note-category { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; margin-right: 0.5rem; }
    .category-general { background-color: #e5e7eb; color: #374151; }
    .category-customer { background-color: #dbeafe; color: #1e40af; }
    .category-lab { background-color: #fef3c7; color: #92400e; }
    .category-payment { background-color: #d1fae5; color: #065f46; }
    .category-important { background-color: #fee2e2; color: #991b1b; }

    /* Reminder statuses */
    .reminder-status { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 12px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .status-pending { background-color: #e5e7eb; color: #374151; }
    .status-due-today { background-color: #fef3c7; color: #92400e; }
    .status-overdue { background-color: #fee2e2; color: #991b1b; }
    .status-completed { background-color: #d1fae5; color: #065f46; }
    .reminder-card.completed { opacity: 0.7; }
    .reminder-card.completed .item-content { text-decoration: line-through; }

    /* Empty state */
    .empty-state { text-align: center; padding: 2rem; color: #666; }
    .empty-state p { margin-bottom: 1rem; }

    /* Dictation Button */
    .textarea-container { position: relative; display: flex; align-items: flex-start; }
    .textarea-container textarea { flex-grow: 1; }
    .dictation-button { margin-left: 5px; padding: 5px; cursor: pointer; background: #eee; border: 1px solid #ccc; border-radius: 4px; font-size: 1.2em; line-height: 1; }
    .dictation-button.listening { background-color: #ffcccc; }
    .visually-hidden { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }

  </style>
</head>

<body>
  <header>
    <div class="container">
      <h1>Xero Search</h1>
      <div id="user-section">
        <div id="tenant-selector" class="hidden" style="margin-right: 15px; display: flex; align-items: center;">
          <select id="tenant-dropdown"
            style="margin-left: 8px; padding: 4px; border-radius: 4px; background-color: #fff; color: #333;">
            <!-- Options will be added via JavaScript -->
          </select>
        </div>
        <button id="login-btn" class="btn primary">Connect to Xero</button>
        <button id="logout-btn" class="btn secondary hidden">Log out</button>
      </div>
    </div>
  </header>

  <main class="container">
    <div id="auth-message" class="message info">
      <p>Please connect to Xero to access your invoices.</p>
    </div>
    <section id="search-section" class="hidden">
      <h2>Search Invoices</h2>
      <div class="search-container">
        <div class="input-wrapper">
          <input type="text" id="search-input" placeholder="Search by invoice number, reference, or customer name..." autocomplete="off">
          <span id="clear-search-btn" class="clear-search-icon hidden">×</span>
        </div>
        <div id="autocomplete-suggestions" class="autocomplete-items hidden"></div>
        <button id="search-btn" class="btn primary">Search</button>
      </div>
      <div class="filters">
        <div class="filter-group">
          <label for="job-status-filter">Job Status:</label>
          <select id="job-status-filter">
            <option value="">All Invoices</option>
            <option value="approaching">Borderline (7-10 days)</option>
            <option value="overdue">Deadline (10+ days)</option>
          </select>
        </div>
      </div>
    </section>
    <div id="loading" class="hidden">
      <div class="spinner"></div>
      <p>Loading invoices...</p>
    </div>
    <section id="results-section" class="hidden">
      <div class="results-header">
        <h2>Search Results <span id="results-count">(0)</span></h2>
        <div class="sorting">
          <select id="sort-by">
            <option value="Date-desc">Sort by latest</option>
            <option value="Date-asc">Sort by oldest</option>
            <option value="Contact.Name-asc">Sort by customer</option>
            <option value="InvoiceNumber-asc">Sort by invoice number</option>
          </select>
        </div>
      </div>
      <div id="results-list"></div>
      <div id="pagination" style="display: flex; justify-content: center; margin-top: 1.5rem;"></div>
    </section>
    <section id="detail-section" class="hidden">
      <button id="back-btn" class="btn secondary">← Back to Results</button>
      <div id="invoice-detail">
          <!-- Invoice details including tabs will be rendered here by JS -->
      </div>
    </section>
    <div id="error-message" class="message error hidden"></div>
    <!-- Global message area for success/info messages -->
    <div id="global-message-area" class="message-area hidden"></div>
  </main>

  <footer>
    <div class="container">
      <p>Xero Search App | Powered by Xero API</p>
    </div>
  </footer>

  <!-- Load the module file FIRST and defer execution -->
  <script src="/notes-reminders.js" defer></script>

  <!-- Load your main inline application logic AFTER the module, also deferred -->
  <script defer>
    // ================================================
    // START OF YOUR MAIN APPLICATION JAVASCRIPT CODE
    // ================================================

    // --- Global Scope Variables ---
    let currentResults = [];
    let currentPage = 1;
    let cachedPages = {};
    const resultsPerPage = 20;
    let autocompleteDebounceTimer;
    const DEBOUNCE_DELAY = 300;
    let currentApiPage = 1;
    let apiHasMorePages = true;
    let isLoadingMoreApiData = false;
    let invoiceNumberSuggestions = [];
    let referenceSuggestions = new Set();
    let contactNameSuggestions = new Set();
    // Use window scope for variables shared across potential future modules or debug
    window.tenantId = null;
    window.tenantName = null;
    window.xeroTenants = null;
    window.xeroTokens = null;
    window.filteredResults = null;
    window.lastPageViewed = 1;
    window.lastScrollPosition = 0;
    window.currentFirebaseStatusMap = {}; // Global map for icon statuses


    // --- Core Application Initialization ---
    function initApp() {
        console.log("Initializing app...");
        cachedPages = {};
        window.lastPageViewed = 1;
        window.lastScrollPosition = 0;
        currentResults = [];
        window.filteredResults = null;
        currentPage = 1;
        window.tenantId = null;
        window.tenantName = null;
        window.xeroTenants = null;
        window.xeroTokens = null; // Make sure tokens are cleared too
        currentApiPage = 1;
        apiHasMorePages = true;
        isLoadingMoreApiData = false;
        invoiceNumberSuggestions = [];
        referenceSuggestions = new Set();
        contactNameSuggestions = new Set();
        window.currentFirebaseStatusMap = {}; // Clear status map

        checkAuthResult();
        checkAuthStatus();
        setupEventListeners();

        if (localStorage.getItem('xero_authenticated') === 'true' && window.tenantId) {
            console.log(`initApp: Auth confirmed. Triggering initial invoice load.`);
            const jobStatusFilter = document.getElementById('job-status-filter');
            const searchInput = document.getElementById('search-input');
            if (jobStatusFilter) jobStatusFilter.value = '';
            if (searchInput) searchInput.value = '';
            loadInitialInvoices();
        } else {
            console.log("initApp: Skipping initial load (not auth/no tenant).");
            updateUI(false);
            const authMessage = document.getElementById('auth-message');
            if (authMessage) authMessage.classList.remove('hidden');
        }
    }

    // --- Authentication and Tenant Handling ---
    function checkAuthResult() {
        const urlParams = new URLSearchParams(window.location.search);
        const authStatus = urlParams.get('auth');
        if (!authStatus) return; // Only process if auth params exist

        console.log("Processing auth result from URL...");
        const errorMessage = urlParams.get('message');
        const tenantNameParam = urlParams.get('tenantName');
        const tenantIdParam = urlParams.get('tenantId');
        const multipleOrgs = urlParams.get('multipleOrgs') === 'true';
        const tenantsParam = urlParams.get('tenants');
        const tokensParam = urlParams.get('tokens');

        // Clear URL params now that we've read them
        window.history.replaceState({}, document.title, window.location.pathname);

        if (authStatus === 'success') {
            localStorage.setItem('xero_authenticated', 'true');
            let determinedTenantId = tenantIdParam;
            let determinedTenantName = tenantNameParam;
            let tenantsList = [];

            if (tenantsParam) {
                try { tenantsList = JSON.parse(decodeURIComponent(tenantsParam)); localStorage.setItem('xero_tenants', JSON.stringify(tenantsList)); window.xeroTenants = tenantsList; if (tenantsList.length > 0 && !determinedTenantId) { determinedTenantId = tenantsList[0].tenantId; determinedTenantName = tenantsList[0].tenantName; } }
                catch (error) { console.error('Error parsing tenants data:', error); if (determinedTenantId) { tenantsList = [{ tenantId: determinedTenantId, tenantName: determinedTenantName || 'Unknown' }]; window.xeroTenants = tenantsList; localStorage.setItem('xero_tenants', JSON.stringify(tenantsList)); } }
            } else if (determinedTenantId) { tenantsList = [{ tenantId: determinedTenantId, tenantName: determinedTenantName || 'Unknown' }]; window.xeroTenants = tenantsList; localStorage.setItem('xero_tenants', JSON.stringify(tenantsList)); }
            else { console.error("Auth success but no tenant info!"); showError("Connected, but couldn't identify organization."); clearAuthData(); updateUI(false); return; }

            if (determinedTenantId) { localStorage.setItem('xero_tenant_id', determinedTenantId); localStorage.setItem('xero_tenant_name', determinedTenantName || 'Unknown Org'); window.tenantId = determinedTenantId; window.tenantName = determinedTenantName || 'Unknown Org'; }
            else { console.error("Failed to determine active tenant ID."); showError("Failed to set active organization."); clearAuthData(); updateUI(false); return; }

            if (tokensParam) {
                try { const tokens = JSON.parse(decodeURIComponent(tokensParam)); localStorage.setItem('xero_tokens', JSON.stringify(tokens)); window.xeroTokens = tokens; }
                catch (error) { console.error('Error parsing tokens data:', error); showError("Connected, but failed to store tokens."); }
            } else { console.error("Auth success but no tokens!"); showError("Authentication succeeded but token data missing."); clearAuthData(); updateUI(false); return; }

            showSuccess(`Connected to Xero: ${window.tenantName || ''}`);
            updateUI(true);
            if (window.xeroTenants && window.xeroTenants.length > 0) displayTenantDropdown(window.xeroTenants);
            if (multipleOrgs || (tenantsList && tenantsList.length > 1)) showMessage("Multiple Xero orgs available. Use dropdown.", "info");
            // Let initApp trigger initial load after this state is set
            // loadInitialInvoices(); // Remove initial load call from here

        } else if (authStatus === 'error' && errorMessage) {
            console.error("Auth error from URL:", errorMessage);
            showError(`Xero connection failed: ${decodeURIComponent(errorMessage)}`);
            clearAuthData(); updateUI(false);
        }
    }

    function checkAuthStatus() {
        console.log("Checking stored auth status...");
        const isAuthenticated = localStorage.getItem('xero_authenticated') === 'true';
        if (isAuthenticated) {
            const tenantId = localStorage.getItem('xero_tenant_id');
            const tenantName = localStorage.getItem('xero_tenant_name');
            const storedTenants = localStorage.getItem('xero_tenants');
            const storedTokens = localStorage.getItem('xero_tokens');

            if (tenantId && storedTokens) {
                window.tenantId = tenantId;
                window.tenantName = tenantName || 'Your Xero Organization';
                try { window.xeroTokens = JSON.parse(storedTokens); } catch(e) { console.error("Stored tokens invalid", e); clearAuthData(); updateUI(false); return; }

                if (storedTenants) {
                    try { window.xeroTenants = JSON.parse(storedTenants); if (!window.xeroTenants.find(t => t.tenantId === window.tenantId) && window.xeroTenants.length > 0) { console.warn("Stored tenant invalid, defaulting."); window.tenantId = window.xeroTenants[0].tenantId; window.tenantName = window.xeroTenants[0].tenantName; localStorage.setItem('xero_tenant_id', window.tenantId); localStorage.setItem('xero_tenant_name', window.tenantName); } }
                    catch (e) { console.error("Stored tenants invalid", e); window.xeroTenants = [{ tenantId: window.tenantId, tenantName: window.tenantName }]; }
                } else { window.xeroTenants = [{ tenantId: window.tenantId, tenantName: window.tenantName }]; localStorage.setItem('xero_tenants', JSON.stringify(window.xeroTenants)); }

                console.log(`Using stored session for tenant: ${window.tenantName} (${window.tenantId})`);
                updateUI(true);
                displayTenantDropdown(window.xeroTenants || []);
            } else { console.warn("Stored session incomplete. Clearing."); clearAuthData(); updateUI(false); }
        } else { console.log("Not authenticated (no stored session)."); updateUI(false); }
    }

    function displayTenantDropdown(tenants) {
        const dropdown = document.getElementById('tenant-dropdown');
        const selectorDiv = document.getElementById('tenant-selector');
        if (!dropdown || !selectorDiv) { console.error("Tenant dropdown elements not found"); return; }

        dropdown.innerHTML = '';
        if (tenants && tenants.length > 0) {
            tenants.forEach(tenant => { const opt = document.createElement('option'); opt.value = tenant.tenantId; opt.textContent = tenant.tenantName || 'Unnamed'; dropdown.appendChild(opt); });
            if (window.tenantId && tenants.some(t => t.tenantId === window.tenantId)) { dropdown.value = window.tenantId; }
            else if (tenants.length > 0) { dropdown.value = tenants[0].tenantId; if (window.tenantId !== tenants[0].tenantId) { window.tenantId = tenants[0].tenantId; window.tenantName = tenants[0].tenantName; localStorage.setItem('xero_tenant_id', window.tenantId); localStorage.setItem('xero_tenant_name', window.tenantName); } }
            selectorDiv.classList.remove('hidden');
            if (!dropdown.dataset.listenerAttached) { dropdown.addEventListener('change', handleTenantChange); dropdown.dataset.listenerAttached = 'true'; }
        } else { selectorDiv.classList.add('hidden'); }
    }

    function handleTenantChange() {
        const dropdown = document.getElementById('tenant-dropdown');
        window.tenantId = dropdown.value;
        window.tenantName = dropdown.options[dropdown.selectedIndex]?.textContent || 'Unknown';
        console.log(`Switched tenant to: ${window.tenantName} (${window.tenantId})`);
        localStorage.setItem('xero_tenant_id', window.tenantId);
        localStorage.setItem('xero_tenant_name', window.tenantName);
        // Reset state for new tenant
        currentResults = []; currentPage = 1; cachedPages = {}; window.filteredResults = null;
        currentApiPage = 1; apiHasMorePages = true; isLoadingMoreApiData = false;
        const rl = document.getElementById('results-list'); const rc = document.getElementById('results-count'); const pg = document.getElementById('pagination');
        if(rl) rl.innerHTML = ''; if(rc) rc.textContent = '(0)'; if(pg) pg.innerHTML = '';
        const jsf = document.getElementById('job-status-filter'); const si = document.getElementById('search-input');
        if(jsf) jsf.value = ''; if(si) si.value = '';
        toggleLoading(true);
        loadInitialInvoices();
        showMessage(`Switched to ${window.tenantName}. Loading...`, 'info');
    }

    async function checkAndRefreshTokens() {
        const tokensJson = localStorage.getItem('xero_tokens');
        if (!tokensJson) return null;
        try {
            const tokens = JSON.parse(tokensJson);
            // Refresh if less than 5 minutes left
            if ((tokens.expires_at - Date.now()) < 5 * 60 * 1000) {
                console.log("Refreshing Xero token...");
                return await refreshTokens(tokens.refresh_token);
            }
            return tokens; // Still valid
        } catch (error) { console.error("Token check error:", error); return null; }
    }

    async function refreshTokens(refreshToken) {
        try {
            const response = await fetch('/api/xero-refresh', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ refresh_token: refreshToken }) });
            if (!response.ok) { const err = await response.json(); throw new Error(err.message || `Server ${response.status}`); }
            const newTokens = await response.json();
            localStorage.setItem('xero_tokens', JSON.stringify(newTokens));
            window.xeroTokens = newTokens;
            console.log("Tokens refreshed.");
            return newTokens;
        } catch (error) { console.error("Token refresh error:", error); showError('Session expired. Reconnect.'); clearAuthData(); updateUI(false); return null; }
    }

    async function getValidTokens() { return await checkAndRefreshTokens(); }

    function clearAuthData() { // Renamed from clearCookies for clarity
        localStorage.removeItem('xero_authenticated');
        localStorage.removeItem('xero_tenant_id');
        localStorage.removeItem('xero_tenant_name');
        localStorage.removeItem('xero_tenants');
        localStorage.removeItem('xero_tokens');
        window.tenantId = null; window.tenantName = null; window.xeroTenants = null; window.xeroTokens = null;
        const dropdown = document.getElementById('tenant-dropdown'); if (dropdown) { dropdown.innerHTML = ''; dropdown.dataset.listenerAttached = 'false'; }
        document.getElementById('tenant-selector')?.classList.add('hidden');
        console.log('Cleared Xero auth data from localStorage.');
    }

    function updateUI(isAuthenticated) {
        document.getElementById('login-btn')?.classList.toggle('hidden', isAuthenticated);
        document.getElementById('logout-btn')?.classList.toggle('hidden', !isAuthenticated);
        document.getElementById('auth-message')?.classList.toggle('hidden', isAuthenticated);
        document.getElementById('search-section')?.classList.toggle('hidden', !isAuthenticated);
        // Results section visibility is handled by loading functions
    }

    // --- Event Listeners Setup ---
    function setupEventListeners() {
        console.log("Setting up event listeners...");
        document.getElementById('login-btn')?.addEventListener('click', () => { window.location.href = '/.netlify/functions/xero-auth'; });
        document.getElementById('logout-btn')?.addEventListener('click', () => { clearAuthData(); window.location.reload(); }); // Use clearAuthData
        document.getElementById('search-btn')?.addEventListener('click', searchInvoices);

        const searchInput = document.getElementById('search-input');
        if (searchInput) {
            searchInput.addEventListener('keypress', event => { if (event.key === 'Enter') searchInvoices(); });
            const debouncedAutocomplete = debounce(handleAutocomplete, DEBOUNCE_DELAY);
            searchInput.addEventListener('input', debouncedAutocomplete);
            searchInput.addEventListener('blur', () => { setTimeout(() => { const ac = document.getElementById('autocomplete-suggestions'); if (ac && !ac.matches(':hover')) { ac.innerHTML = ''; ac.classList.add('hidden'); } }, 150); });
            searchInput.addEventListener('focus', () => { if (searchInput.value.trim().length > 0) handleAutocomplete(); });
        }

        const jobStatusFilter = document.getElementById('job-status-filter');
        if (jobStatusFilter) { jobStatusFilter.addEventListener('change', handleFilterChange); } // Use named handler

        const sortBySelect = document.getElementById('sort-by');
        if (sortBySelect) { sortBySelect.addEventListener('change', handleSortChange); } // Use named handler

        const backBtn = document.getElementById('back-btn');
        if (backBtn) { backBtn.addEventListener('click', handleBackButtonClick); } // Use named handler

        const clearSearchBtn = document.getElementById('clear-search-btn');
        if (searchInput && clearSearchBtn) {
            searchInput.addEventListener('input', () => { clearSearchBtn.classList.toggle('hidden', searchInput.value.length === 0); if(searchInput.value.length === 0) { const ac = document.getElementById('autocomplete-suggestions'); if(ac){ ac.innerHTML = ''; ac.classList.add('hidden');}} });
            clearSearchBtn.addEventListener('click', handleClearSearch); // Use named handler
        }
        console.log("Event listeners setup complete.");
    }

    // --- Event Handlers ---
    async function handleFilterChange() {
        const selectedStatus = this.value;
        const term = document.getElementById('search-input')?.value.trim() || '';
        console.log(`Filter change: ${selectedStatus}, Term: ${term}`);
        toggleLoading(true);
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) resultsSection.style.opacity = '0.5'; // Visual feedback
        try {
            if (!selectedStatus) { // "All Invoices" selected
                window.filteredResults = null; currentApiPage = 1; apiHasMorePages = true; isLoadingMoreApiData = false; cachedPages = {}; currentResults = [];
                await loadInitialInvoices(); // Reload initial view
            } else if (term) { // Status selected + search term
                await searchInvoices(); // Re-run search (it will apply filter client-side)
            } else { // Status selected, no search term
                await loadInvoicesByStatus(selectedStatus); // Load specifically by status
            }
        } catch (e) { console.error("Filter error:", e); showError("Error applying filter."); }
        finally { toggleLoading(false); if (resultsSection) resultsSection.style.opacity = '1'; }
    }

    function handleSortChange() {
        console.log('Sort changed');
        if (window.filteredResults !== null && Array.isArray(window.filteredResults)) {
            console.log('Sorting filtered results...');
            sortSpecificResults(window.filteredResults); // Implement this if specific sort needed
            displayFilteredResults();
        } else {
            console.log('Sorting main results...');
            sortResults(); // Sorts currentResults and calls displayResultItems
        }
    }

    function handleBackButtonClick() {
        document.getElementById('detail-section')?.classList.add('hidden');
        const resultsSection = document.getElementById('results-section');
        if (resultsSection) {
            resultsSection.classList.remove('hidden');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        // Maybe restore previous search state here if needed
    }

    function handleClearSearch() {
        console.log('Clear search clicked');
        const searchInput = document.getElementById('search-input');
        const clearBtn = document.getElementById('clear-search-btn');
        const suggestions = document.getElementById('autocomplete-suggestions');
        const statusFilter = document.getElementById('job-status-filter');
        if(searchInput) searchInput.value = '';
        if(clearBtn) clearBtn.classList.add('hidden');
        if(suggestions){ suggestions.innerHTML = ''; suggestions.classList.add('hidden'); }
        if(statusFilter) statusFilter.value = '';
        loadInitialInvoices(); // Reload "All"
        if(searchInput) searchInput.focus();
        showMessage('Search cleared.', 'info');
    }

    // --- Data Fetching & Processing ---
    async function loadInitialInvoices() {
        currentResults = []; window.filteredResults = null; currentPage = 1;
        currentApiPage = 1; apiHasMorePages = true; isLoadingMoreApiData = false;
        cachedPages = {}; window.currentFirebaseStatusMap = {}; // Clear status map
        console.log("loadInitialInvoices: Fetching initial...");
        toggleLoading(true);
        try {
            const initialData = await fetchInvoicePageApi(1, 100); // Fetch first 100
            if (initialData?.invoices?.length > 0) {
                currentResults = initialData.invoices;
                updateAutocompleteSources(currentResults);
                apiHasMorePages = initialData.hasMore;
                const accountNumbers = currentResults.map(inv => inv.Contact?.AccountNumber).filter(Boolean);
                if (accountNumbers.length > 0) window.currentFirebaseStatusMap = await fetchFirebaseStatuses(accountNumbers);
                document.getElementById('results-section')?.classList.remove('hidden');
                document.getElementById('results-count').textContent = `(${currentResults.length} loaded)`;
                const o = currentResults.filter(i => getJobStatus(i)==='overdue').length; const a = currentResults.filter(i => getJobStatus(i)==='approaching').length;
                showMessage(`Loaded ${currentResults.length} invoices (${o} deadline, ${a} borderline).`, 'info');
                sortResults(); // Sorts and displays first page
            } else { /* Handle no initial results */ document.getElementById('results-section')?.classList.add('hidden'); showMessage("No recent invoices found.", 'info'); apiHasMorePages = false; displayResultItems();}
        } catch (e) { /* Handle error */ console.error("Initial load error:", e); showError("Error: " + e.message); document.getElementById('results-section')?.classList.add('hidden'); }
        finally { toggleLoading(false); }
    }

    async function fetchInvoicePageApi(page, pageSize) {
        console.log(`Fetching API page ${page}, size ${pageSize}`);
        if (!window.tenantId) throw new Error("Tenant ID missing.");
        const tokens = await getValidTokens(); if (!tokens) throw new Error('No valid tokens.');
        const url = new URL(`/api/xero-api/invoices`, window.location.origin);
        const daysAgo = new Date(); daysAgo.setDate(daysAgo.getDate() - 45);
        const formattedDate = daysAgo.toISOString().split('T')[0];
        const whereClause = `Date>=DateTime(${formattedDate.replace(/-/g, ',')}) AND Type=="ACCREC" AND Status!="PAID"`;
        url.searchParams.set('where', whereClause); url.searchParams.set('order', 'Date DESC');
        url.searchParams.set('page', page.toString()); url.searchParams.set('pageSize', pageSize.toString());
        try {
            const response = await fetch(url.toString(), { headers: { 'Authorization': `Bearer ${tokens.access_token}`, 'Xero-Tenant-Id': window.tenantId } });
            if (!response.ok) { const et = await response.text(); try { const ed = JSON.parse(et); throw new Error(ed.message || `API Error ${response.status}: ${et}`); } catch (e) { throw new Error(`API Error ${response.status}: ${et}`); } }
            const data = await response.json(); const invoices = data?.Invoices || []; const hasMore = invoices.length === pageSize;
            console.log(`API page ${page} got ${invoices.length}. HasMore: ${hasMore}`);
            return { invoices, hasMore };
        } catch (e) { console.error(`API fetch page ${page} error:`, e); throw e; }
    }

    // --- NEW Function to Fetch Firebase Status ---
    async function fetchFirebaseStatuses(accountNumbers) {
        const uniqueAccountNumbers = [...new Set(accountNumbers)].filter(accNum => accNum && typeof accNum === 'string' && accNum.trim() !== '');
        if (uniqueAccountNumbers.length === 0) return {};
        console.log(`Fetching Firebase status for ${uniqueAccountNumbers.length} accounts...`);
        try {
            const response = await fetch('/api/firebase-api/batch-status', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ accountNumbers: uniqueAccountNumbers }) });
            if (!response.ok) { const errorBody = await response.text(); console.error(`Error fetching statuses: ${response.status}`, errorBody); return {}; }
            const statusMap = await response.json(); console.log('Received Firebase status map:', statusMap); return statusMap;
        } catch (error) { console.error('Failed fetchFirebaseStatuses:', error); return {}; }
    }
    // --- End New Function ---

    async function searchInvoices() {
        const searchInput = document.getElementById('search-input');
        const searchTerm = searchInput ? searchInput.value.trim() : '';
        if (!searchTerm) { await loadInitialInvoices(); showMessage('Showing all recent invoices...', 'info'); return; }
        console.log(`Searching for: "${searchTerm}"`);
        const tokens = await getValidTokens(); if (!tokens) { showError('Auth token issue.'); return; }
        toggleLoading(true); window.currentFirebaseStatusMap = {}; // Clear previous statuses
        try {
            const url = new URL(`/api/xero-api/invoices`, window.location.origin);
            url.searchParams.set('order', 'Date DESC'); url.searchParams.set('page', '1'); url.searchParams.set('pageSize', '50');
            const headers = { 'Authorization': `Bearer ${tokens.access_token}`, 'Xero-Tenant-Id': window.tenantId };
            const whereConditions = [`Type=="ACCREC"`];
            const thirtyDaysAgo = new Date(); thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30); const fd=thirtyDaysAgo.toISOString().split('T')[0]; whereConditions.push(`Date>=DateTime(${fd.replace(/-/g, ',')})`);
            const st=searchTerm.replace(/\\/g, '\\\\').replace(/"/g, '\\"').replace(/'/g, "''").toLowerCase(); whereConditions.push(`((InvoiceNumber!=null AND InvoiceNumber.ToLower().Contains("${st}")) OR (Reference!=null AND Reference.ToLower().Contains("${st}")) OR (Contact.Name!=null AND Contact.Name.ToLower().Contains("${st}")))`);
            const wc = whereConditions.join(' AND '); url.searchParams.append('where', wc);
            const response = await fetch(url.toString(), { method: 'GET', headers });
            if (!response.ok) { const et = await response.text(); try { const ed = JSON.parse(et); throw new Error(ed.Detail||ed.message||et||`Server ${response.status}`); } catch (pe) { throw new Error(et||`Server ${response.status}`); } }
            const data = await response.json(); let fetchedInvoices = data?.Invoices || [];
            const jobStatusFilterEl = document.getElementById('job-status-filter'); const ss = jobStatusFilterEl ? jobStatusFilterEl.value : ''; let finalResults = ss ? fetchedInvoices.filter(i => getJobStatus(i) === ss) : fetchedInvoices;
            if (finalResults.length > 0) {
                currentResults = finalResults; updateAutocompleteSources(currentResults); currentPage = 1; window.filteredResults = null; currentApiPage = 1; apiHasMorePages = fetchedInvoices.length === 50;
                const accountNumbers = currentResults.map(inv => inv.Contact?.AccountNumber).filter(Boolean);
                if (accountNumbers.length > 0) window.currentFirebaseStatusMap = await fetchFirebaseStatuses(accountNumbers);
                displayResults();
            } else { /* Handle no search results */ currentResults = []; window.filteredResults = null; window.currentFirebaseStatusMap = {}; document.getElementById('results-list').innerHTML = ''; document.getElementById('results-count').textContent = '(0)'; document.getElementById('pagination').innerHTML = ''; document.getElementById('results-section').classList.remove('hidden'); showMessage('No invoices found matching criteria.', 'info'); }
        } catch (e) { /* Handle search error */ console.error("Search error:", e); showError(`Search error: ${e?.message||e}`); currentResults=[]; window.filteredResults=null; window.currentFirebaseStatusMap={}; /* Clear UI */ }
        finally { toggleLoading(false); }
    }

    async function loadInvoicesByStatus(status) { /* ... (Keep existing, ensure it clears window.currentFirebaseStatusMap initially and sets it before calling displayFilteredResults if results found) ... */
        console.log(`Load by status: ${status}`);
        toggleLoading(true); window.filteredResults = null; currentResults = []; currentPage = 1; cachedPages = {}; window.currentFirebaseStatusMap = {}; // Clear map
        try {
            const tokens = await getValidTokens(); if (!tokens) throw new Error('No valid tokens');
            let daysToLookBack, statusName; if (status === 'overdue'){daysToLookBack=60; statusName='deadline';} else if (status === 'approaching'){daysToLookBack=30; statusName='borderline';} else {throw new Error(`Invalid status: ${status}`);}
            const lookBackDate = new Date(); lookBackDate.setDate(lookBackDate.getDate() - daysToLookBack); const fd = lookBackDate.toISOString().split('T')[0];
            const url = new URL(`/api/xero-api/invoices`, window.location.origin); let wc = `Date>=DateTime(${fd.replace(/-/g, ',')}) AND Type=="ACCREC" AND Status!="PAID"`; url.searchParams.set('where', wc); url.searchParams.set('order', 'Date DESC');
            console.log(`Fetching potential '${statusName}' since ${fd}...`);
            const allPotential = await fetchAllPages(url.toString(), tokens.access_token);
            if (allPotential.length > 0) {
                const filtered = allPotential.filter(i => getJobStatus(i) === status);
                console.log(`Filtered to ${filtered.length} actual '${statusName}'.`);
                window.filteredResults = filtered; updateAutocompleteSources(window.filteredResults);
                if (window.filteredResults.length > 0) {
                    const accountNumbers = window.filteredResults.map(inv => inv.Contact?.AccountNumber).filter(Boolean);
                    if (accountNumbers.length > 0) window.currentFirebaseStatusMap = await fetchFirebaseStatuses(accountNumbers); // Fetch statuses for filtered results
                    document.getElementById('results-section')?.classList.remove('hidden'); document.getElementById('results-count').textContent = `(${window.filteredResults.length})`; showMessage(`Found ${window.filteredResults.length} ${statusName} invoices.`, 'info');
                    displayFilteredResults(); // This will now use window.currentFirebaseStatusMap
                } else { /* Handle no matches after filtering */ window.filteredResults = []; document.getElementById('results-section')?.classList.remove('hidden'); document.getElementById('results-list').innerHTML = `<div class="message info">No ${statusName} found.</div>`; document.getElementById('results-count').textContent = '(0)'; document.getElementById('pagination').innerHTML = ''; }
            } else { /* Handle no results from initial fetch */ window.filteredResults = []; document.getElementById('results-section')?.classList.add('hidden'); showMessage(`No invoices in last ${daysToLookBack} days.`, 'info'); document.getElementById('results-count').textContent = '(0)'; document.getElementById('pagination').innerHTML = ''; }
        } catch (e) { console.error(`Error loading by status (${status}):`, e); showError(`Error: ${e.message}`); document.getElementById('results-section')?.classList.add('hidden'); }
        finally { toggleLoading(false); }
    }

    async function fetchAllPages(baseUrl, accessToken) { /* ... (Keep existing fetchAllPages) ... */ let p=1; const ps=100; let ar=[]; let hmp=true; showMessage("Fetching...", "info"); toggleLoading(true); while(hmp){try{/*...fetch logic...*/ const d=await rp.json(); const inv=d?.Invoices||[]; if(inv.length>0){ar=[...ar,...inv]; if(ar.length%(ps*2)===0||inv.length<ps)showMessage(`Fetched ${ar.length}...`,"info"); hmp=inv.length===ps; p++;}else{hmp=false;} if(ar.length>=1000){showMessage(`Limit ${ar.length}. Refine?`,"warning");hmp=false;}}catch(e){/*...*/hmp=false;}} toggleLoading(false); setTimeout(()=>{/*...*/},2000); return ar;}

    // --- UI Display and Rendering ---
    function displayResults() { // This function is now simpler, mainly calls displayResultItems or displayFilteredResults
        console.log("displayResults called");
        const resultsSection = document.getElementById('results-section');
        const resultsCount = document.getElementById('results-count');
        if (!resultsSection || !resultsCount) { console.error("Results UI elements missing!"); return; }

        // Decide which display function to use based on filter state
        if (window.filteredResults !== null) {
            displayFilteredResults(); // Display filtered results
        } else {
            displayResultItems(); // Display "All" (potentially paginated from API) results
        }
    }

    function displayResultItems() { // Displays "All" results, handles API pagination
        const resultsList = document.getElementById('results-list');
        if (!resultsList) return;
        const isAllFilterActive = !document.getElementById('job-status-filter')?.value && !window.filteredResults;
        const requiredIndex = (currentPage - 1) * resultsPerPage;

        // Fetch more API data if needed ONLY for the "All" view
        if (isAllFilterActive && requiredIndex >= currentResults.length && apiHasMorePages && !isLoadingMoreApiData) {
            isLoadingMoreApiData = true; toggleLoading(true); showMessage("Loading more...", "info");
            fetchInvoicePageApi(currentApiPage + 1, 100).then(async nextPageData => { // Make async to await status fetch
                currentResults = [...currentResults, ...nextPageData.invoices];
                updateAutocompleteSources(nextPageData.invoices);
                currentApiPage++; apiHasMorePages = nextPageData.hasMore;
                // Fetch statuses for NEWLY loaded items and merge
                const newAccountNumbers = nextPageData.invoices.map(inv => inv.Contact?.AccountNumber).filter(Boolean);
                if (newAccountNumbers.length > 0) {
                    const newStatuses = await fetchFirebaseStatuses(newAccountNumbers);
                    window.currentFirebaseStatusMap = { ...window.currentFirebaseStatusMap, ...newStatuses }; // Merge maps
                }
            }).catch(e => { showError(`Failed load more: ${e.message}`); apiHasMorePages = false; })
            .finally(() => { isLoadingMoreApiData = false; toggleLoading(false); setTimeout(/*...*/); displayResultItems(); /* Re-render */ });
            return; // Exit while loading more
        }

        resultsList.innerHTML = ''; // Clear list
        const resultsToDisplay = currentResults;
        const totalLoadedResults = resultsToDisplay.length;
        if(isAllFilterActive) document.getElementById('results-count').textContent = `(${totalLoadedResults}${apiHasMorePages ? '+ loaded' : ' total'})`;

        const startIndex = (currentPage - 1) * resultsPerPage;
        const endIndex = Math.min(startIndex + resultsPerPage, totalLoadedResults);
        const pageResults = resultsToDisplay.slice(startIndex, endIndex);

        if (pageResults.length === 0 && totalLoadedResults === 0) { resultsList.innerHTML = `<div class="message info">No invoices.</div>`; updatePagination(); return; }

        const pageContent = document.createDocumentFragment();
        pageResults.forEach(invoice => { try { pageContent.appendChild(createInvoiceItem(invoice)); } catch (e) { console.error("Error rendering:", e, invoice); } });
        resultsList.appendChild(pageContent);
        updatePagination(); // Update pagination based on currently loaded results
    }

    function displayFilteredResults() { // Displays filtered results (already loaded)
        const resultsList = document.getElementById('results-list'); if (!resultsList) return;
        const resultsCount = document.getElementById('results-count');
        const filteredCount = window.filteredResults ? window.filteredResults.length : 0;
        if(resultsCount) resultsCount.textContent = `(${filteredCount} matching filter)`;

        if (!window.filteredResults || filteredCount === 0) { resultsList.innerHTML = `<div class="message info">No invoices match filter.</div>`; updatePagination(); return; }

        const totalPages = Math.ceil(filteredCount / resultsPerPage);
        if (currentPage > totalPages && totalPages > 0) currentPage = totalPages; // Adjust current page if needed
        const startIndex = (currentPage - 1) * resultsPerPage;
        const endIndex = Math.min(startIndex + resultsPerPage, filteredCount);
        const pageResults = window.filteredResults.slice(startIndex, endIndex);

        resultsList.innerHTML = ''; // Clear list
        const pageContent = document.createDocumentFragment();
        pageResults.forEach(invoice => { try { pageContent.appendChild(createInvoiceItem(invoice)); } catch (e) { console.error("Error rendering filtered:", e, invoice); } });
        resultsList.appendChild(pageContent);
        updatePagination(); // Update pagination based on filtered results
    }

    function createInvoiceItem(invoice) { // Adds icons using global map
        const item = document.createElement('div'); item.className = 'result-item';
        const jobStatus = getJobStatus(invoice); if (jobStatus) item.classList.add(jobStatus);
        if (invoice.InvoiceID) item.dataset.id = invoice.InvoiceID;
        const date = formatDate(invoice.Date); const dueDate = formatDate(invoice.DueDate);
        const invoiceDate = parseXeroDate(invoice.Date); const businessDays = invoiceDate ? getBusinessDaysDifference(invoiceDate, new Date()) : null;
        let jobAgeHtml = ''; if (businessDays !== null) { if (businessDays > 10) jobAgeHtml = `<div class="job-age job-overdue">Deadline: ${businessDays}d</div>`; else if (businessDays >= 7) jobAgeHtml = `<div class="job-age job-approaching">Borderline: ${businessDays}d</div>`; else jobAgeHtml = `<div class="job-age job-recent">${businessDays}d</div>`; }
        const invNumLink = invoice.InvoiceNumber || ''; const labNum = extractSixDigitInvoiceNumber(invNumLink); let labLink = '#'; if (labNum) labLink = `https://www.dropbox.com/preview/TTL%20Prescription%20copies/${labNum}.jpg?role=personal`;

        // Get status from global map
        const accountNum = invoice.Contact?.AccountNumber;
        const status = (accountNum && window.currentFirebaseStatusMap && window.currentFirebaseStatusMap[accountNum]) ? window.currentFirebaseStatusMap[accountNum] : { hasNote: false, hasReminder: false };

        item.innerHTML = `
          <div class="result-header">
            <div class="invoice-number">
              Inv #${invoice.InvoiceNumber || 'N/A'}
              <span class="invoice-status-icons"></span> {/* Icons Added Here */}
            </div>
            <div class="invoice-status status-${(invoice.Status || '').toLowerCase()}">${invoice.Status || 'N/A'}</div>
          </div>
          <div class="result-details">
            <div><span>Customer</span><span>${invoice.Contact?.Name || 'N/A'}</span></div>
            <div><span>Reference</span><span>${invoice.Reference || 'N/A'}</span>${labNum ? `<div style="margin-top:0.25rem;"><a href="${labLink}" target="_blank" rel="noopener noreferrer" class="rx-link" style="font-size:0.8em;text-decoration:underline;color:var(--primary-color);">Lab Form</a></div>` : ''}</div>
            <div><span>Date</span><span>${date}</span>${jobAgeHtml}</div>
            <div><span>Due</span><span>${dueDate}</span></div>
            <div><span>Amount</span><span>${invoice.CurrencyCode || ''} ${invoice.Total?.toFixed(2) || 'N/A'}</span></div>
          </div>`;

        const iconContainer = item.querySelector('.invoice-status-icons');
        if (iconContainer) {
            if (status.hasNote) { const icon = document.createElement('span'); icon.textContent = '📝'; icon.title = 'Has Notes'; icon.className = 'status-icon note-icon'; iconContainer.appendChild(icon); }
            if (status.hasReminder) { const icon = document.createElement('span'); icon.textContent = '⏰'; icon.title = 'Has Reminders'; icon.className = 'status-icon reminder-icon'; iconContainer.appendChild(icon); }
        }

        if (invoice.InvoiceID) item.addEventListener('click', showInvoiceDetailById); // Use named handler
        const rxLink = item.querySelector('.rx-link'); if (rxLink) rxLink.addEventListener('click', (e) => { e.stopPropagation(); });
        return item;
    }

    function updatePagination() { /* ... (Keep existing updatePagination - it determines buttons based on state) ... */ const pg=document.getElementById('pagination'); if(!pg)return; pg.innerHTML=''; let rtu,trc,tp; const isf=!!document.getElementById('job-status-filter')?.value; const isfa=window.filteredResults!==null&&window.filteredResults!==undefined; let hp=currentPage>1; let hn=false; if(isf&&isfa){rtu=window.filteredResults; trc=rtu.length; tp=Math.ceil(trc/resultsPerPage); hn=currentPage<tp;}else{rtu=currentResults; trc=rtu.length; hn=(currentPage*resultsPerPage<trc)||apiHasMorePages;} let ba=false; if(currentPage>1){const fb=document.createElement('button'); fb.textContent='First'; fb.className='btn secondary'; fb.addEventListener('click',()=>{if(currentPage!==1){window.lastScrollPosition=window.scrollY; currentPage=1; if(isf&&isfa)displayFilteredResults(); else displayResultItems();}}); pg.appendChild(fb); ba=true;} if(hp){const pb=document.createElement('button'); pb.textContent='Previous'; pb.className='btn secondary'; pb.addEventListener('click',()=>{if(currentPage>1){window.lastScrollPosition=window.scrollY; currentPage--; if(isf&&isfa)displayFilteredResults(); else displayResultItems();}}); pg.appendChild(pb); ba=true;} if(hn){const nb=document.createElement('button'); nb.textContent='Next'; nb.className='btn primary'; nb.addEventListener('click',()=>{window.lastScrollPosition=window.scrollY; currentPage++; if(isf&&isfa)displayFilteredResults(); else displayResultItems();}); pg.appendChild(nb); ba=true;} pg.style.display=ba?'flex':'none'; }

    async function showInvoiceDetail(invoiceId) { /* ... (Keep existing, including the window.notesAndReminders.init(invoice) call) ... */ try{toggleLoading(true); const tk=await getValidTokens(); if(!tk)throw new Error('No valid tokens'); const u=`${window.location.origin}/api/xero-api/invoices/${invoiceId}`; const rp=await fetch(u,{headers:{'Authorization':`Bearer ${tk.access_token}`,'Xero-Tenant-Id':window.tenantId}}); if(!rp.ok){const ed=await rp.json(); throw new Error(ed.message||`Server ${rp.status}`);} const d=await rp.json(); if(d?.Invoices?.length>0){const inv=d.Invoices[0]; document.getElementById('results-section')?.classList.add('hidden'); document.getElementById('detail-section')?.classList.remove('hidden'); const de=document.getElementById('invoice-detail'); /* ... build invoiceDetailsHtml ... */ const idHtml = `...`; /* ... build tabs HTML ... */ de.innerHTML = `<div class="tabs-container">...</div>`; /* ... init tabs ... */ const tb=de.querySelectorAll('.tab-button'); tb.forEach(b=>{/*...*/}); if(window.notesAndReminders){window.notesAndReminders.init(inv);}else{console.warn('Notes/reminders func not loaded');}}else{showError('Inv not found');}}catch(e){console.error('Error get details:',e);showError('Error loading details.');}finally{toggleLoading(false);} }
    function showInvoiceDetailById(event) { let te = event.target; while (te && !te.classList.contains('result-item')) { te = te.parentElement; } const iid = te?.dataset.id; if (iid) showInvoiceDetail(iid); }

    // --- Utility Functions ---
    function parseXeroDate(xeroDateString) { if (!xeroDateString) return null; const m = /\/Date\((\d+).*\)\//.exec(xeroDateString); if (m && m[1]) return new Date(parseInt(m[1], 10)); if (typeof xeroDateString === 'string' && xeroDateString.includes('T')) return new Date(xeroDateString); const d = new Date(xeroDateString); return !isNaN(d.getTime()) ? d : null; }
    function debounce(func, delay) { let timer; return function(...args){ clearTimeout(timer); timer = setTimeout(() => { func.apply(this, args); }, delay); }; }
    function updateAutocompleteSources(invoices) { if (!invoices?.length) return; invoices.forEach(i => { if (i.InvoiceNumber && !invoiceNumberSuggestions.includes(i.InvoiceNumber)) invoiceNumberSuggestions.push(i.InvoiceNumber); if (i.Reference) referenceSuggestions.add(i.Reference); if (i.Contact?.Name) contactNameSuggestions.add(i.Contact.Name); }); invoiceNumberSuggestions.sort(); }
    function handleAutocomplete() { /* ... (Keep existing handleAutocomplete) ... */ const i=document.getElementById('search-input'); const sc=document.getElementById('autocomplete-suggestions'); const v=i.value.trim().toLowerCase(); if(v.length<1){sc.innerHTML=''; sc.classList.add('hidden'); return;} const ms=10; let s=[]; if(Array.isArray(invoiceNumberSuggestions))invoiceNumberSuggestions.forEach(n=>{if(n?.toLowerCase().startsWith(v))s.push({type:'Inv #',text:n});}); if(typeof referenceSuggestions?.forEach==='function')referenceSuggestions.forEach(r=>{if(r?.toLowerCase().startsWith(v)&&s.length<ms&&!s.some(x=>x.text===r))s.push({type:'Ref',text:r});}); if(typeof contactNameSuggestions?.forEach==='function')contactNameSuggestions.forEach(n=>{if(n?.toLowerCase().startsWith(v)&&s.length<ms&&!s.some(x=>x.text===n))s.push({type:'Cust',text:n});}); s=s.slice(0,ms); sc.innerHTML=''; if(s.length>0){s.forEach(sg=>{const d=document.createElement('div'); const ht=sg.text.startsWith(i.value)?`<strong>${sg.text.substring(0,i.value.length)}</strong>${sg.text.substring(i.value.length)}`:sg.text; d.innerHTML=`${ht} <span style="color:#888;font-size:0.8em;float:right;">(${sg.type})</span>`; d.addEventListener('click',()=>{i.value=sg.text; sc.innerHTML=''; sc.classList.add('hidden'); searchInvoices();}); sc.appendChild(d);}); sc.classList.remove('hidden');}else{sc.classList.add('hidden');}}
    function formatDate(dateValue) { const d = parseXeroDate(dateValue); return d ? d.toLocaleDateString() : 'N/A'; }
    function getBusinessDaysDifference(startDate, endDate) { if (!startDate || !endDate) return null; const s = startDate instanceof Date ? startDate : new Date(startDate); const e = endDate instanceof Date ? endDate : new Date(endDate); if (isNaN(s.getTime()) || isNaN(e.getTime())) return null; let c = 0; let cur = new Date(s); while (cur <= e) { const d = cur.getDay(); if (d !== 0 && d !== 6) c++; cur.setDate(cur.getDate() + 1); } return c; }
    function getJobStatus(invoice) { if (invoice.Status === 'PAID' || invoice.Type === 'ACCPAY') return null; const sd = parseXeroDate(invoice.Date); if (!sd) return null; const bd = getBusinessDaysDifference(sd, new Date()); if (bd === null) return null; if (bd > 10) return 'overdue'; if (bd >= 7) return 'approaching'; return 'recent'; }
    function sortResults() { if (!currentResults?.length) return; const sv=document.getElementById('sort-by')?.value; if(!sv) return; const [sb,so]=sv.split('-'); currentResults.sort((a,b)=>{ /* ... sort logic ... */ let vA,vB; if(sb==='Date'||sb==='DueDate'){vA=parseXeroDate(a[sb])?.getTime()||0;vB=parseXeroDate(b[sb])?.getTime()||0;}else if(sb.includes('.')){const p=sb.split('.'); vA=a; vB=b; try{for(const pt of p){vA=vA?.[pt];vB=vB?.[pt];}}catch(e){vA=null;vB=null;}}else{vA=a?.[sb];vB=b?.[sb];} if(vA===undefined||vA===null)return so==='asc'?-1:1; if(vB===undefined||vB===null)return so==='asc'?1:-1; if(typeof vA==='string'&&typeof vB==='string')return so==='asc'?vA.localeCompare(vB):vB.localeCompare(vA); const nA=parseFloat(vA); const nB=parseFloat(vB); if(!isNaN(nA)&&!isNaN(nB))return so==='asc'?nA-nB:nB-nA; return so==='asc'?(vA<vB?-1:vA>vB?1:0):(vB<vA?-1:vB>vA?1:0);}); displayResultItems(); } // Re-render after sort
    function sortSpecificResults(resultsArray) { if (!resultsArray?.length) return; const sv=document.getElementById('sort-by')?.value; if(!sv) return; const [sb,so]=sv.split('-'); resultsArray.sort((a,b)=>{/* ... same sort logic as sortResults ... */let vA,vB; if(sb==='Date'||sb==='DueDate'){vA=parseXeroDate(a[sb])?.getTime()||0;vB=parseXeroDate(b[sb])?.getTime()||0;}else if(sb.includes('.')){const p=sb.split('.'); vA=a; vB=b; try{for(const pt of p){vA=vA?.[pt];vB=vB?.[pt];}}catch(e){vA=null;vB=null;}}else{vA=a?.[sb];vB=b?.[sb];} if(vA===undefined||vA===null)return so==='asc'?-1:1; if(vB===undefined||vB===null)return so==='asc'?1:-1; if(typeof vA==='string'&&typeof vB==='string')return so==='asc'?vA.localeCompare(vB):vB.localeCompare(vA); const nA=parseFloat(vA); const nB=parseFloat(vB); if(!isNaN(nA)&&!isNaN(nB))return so==='asc'?nA-nB:nB-nA; return so==='asc'?(vA<vB?-1:vA>vB?1:0):(vB<vA?-1:vB>vA?1:0);}); } // Just sorts the passed array
    function toggleLoading(show) { document.getElementById('loading')?.classList.toggle('hidden', !show); }
    function showError(message, autoHide=true) { const el=document.getElementById('error-message'); if(!el)return; el.textContent=message; el.className='message error'; el.classList.remove('hidden'); if(autoHide) setTimeout(()=>{ el.classList.add('hidden'); }, 8000); console.error("Error:", message); }
    function showSuccess(message) { showMessage(message, 'success'); }
    function showMessage(message, type='info') { const el=document.getElementById('error-message'); if(!el)return; el.textContent=message; el.className=`message ${type}`; el.classList.remove('hidden'); setTimeout(()=>{ el.classList.add('hidden'); }, 5000); }
    function extractSixDigitInvoiceNumber(text) { if (!text) return null; const m = text.match(/\d{6}/); return m ? m[0] : null; }


    // --- Initialize the App ---
    // Use DOMContentLoaded listener to ensure HTML is parsed before running initApp
    document.addEventListener('DOMContentLoaded', initApp);

  </script> <!-- End of the main application logic script -->

</body>
</html>